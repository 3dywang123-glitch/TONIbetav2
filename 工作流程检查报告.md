# TONI 工作流程检查报告

## ✅ 已正确实现的部分

### 1. 网络连接与硬件发现
- ✅ UDP 广播发现机制 (`WHO_IS_TONI?` / `I_AM_TONI`)
- ✅ BLE 配网模式
- ✅ 设备IP自动锁定

### 2. 硬件端执行逻辑
- ✅ T+0.1s: 热机VGA（静默，内部销毁）
- ✅ T+0.6s: 秘书图VGA（回传App）
- ✅ T+2.0s: 热机QXGA（内部销毁）
- ✅ T+3.0s: 决战图QXGA（回传App）
- ✅ 激光闪烁序列（慢闪→快闪→常亮）
- ✅ UDP事件通知 (`EVENT:VGA_READY`, `EVENT:HD_READY`)

### 3. App端逻辑中枢
- ✅ VAD启动和流式识别
- ✅ First_Command捕获（前3-5秒或第一个完整句子）
- ✅ Full_Context捕获（完整对话）
- ✅ 图像缓存：Cache_A (VGA), Cache_B (QXGA), Cache_C (裁剪540x720)
- ✅ 自动裁剪逻辑（居中裁剪）

### 4. 后台交互与AI决策
- ✅ 秘书AI：First_Command + 图A → 返回reply, expert, camera_action
- ✅ 专家AI：Full_Context + 图B/图C + secretary_context
- ✅ 图像选择逻辑：normal用图C，wide用图B
- ✅ 本地优先存储策略

---

## ⚠️ 需要调整和补充的部分

### 1. **连拍功能未实现** ⚠️ 重要

**工作逻辑要求：**
- 如果进入连拍模式，App不应丢弃T3.0s拍的高清图
- App发送 `GET /burst?count=4` 让板子补拍剩下的图
- 最终发给专家的是 [Img1, Img2, Img3, Img4, Img5]

**当前状态：**
- ❌ 代码中完全没有连拍相关逻辑
- ❌ 固件中没有 `/burst` 接口
- ❌ App中没有连拍模式触发机制

**建议实现：**
```dart
// 1. 在 ImageCacheService 中添加连拍缓存
List<Uint8List> _burstImages = [];

// 2. 在固件中添加 /burst 接口
server.on("/burst", HTTP_GET, [](){
  int count = server.arg("count").toInt();
  // 执行连拍逻辑
});

// 3. 在 HomeScreen 中添加连拍模式检测
// 检测条件：用户快速连续触发，或AI判断需要多角度
```

### 2. **音频处理时序优化** ⚠️ 建议

**工作逻辑要求：**
- 节点1：识别出第一个完整句子（或前3-5秒）→ First_Command
- 节点2：继续录音直到用户彻底闭嘴（静默检测）→ Full_Context

**当前实现：**
- ✅ 有First_Command捕获（5秒定时器）
- ⚠️ 静默检测可能不够精确

**建议优化：**
- 使用VAD的静默检测阈值，而不是固定时间
- 确保First_Command在VGA图就绪时已经准备好

### 3. **图像裁剪尺寸确认** ✅ 正确

**工作逻辑要求：**
- Cache_B居中裁剪为 540x720 → Cache_C

**当前实现：**
- ✅ 代码中已实现540x720裁剪
- ✅ 居中裁剪逻辑正确

### 4. **UDP事件处理时序** ⚠️ 需要验证

**工作逻辑要求：**
- T+0.6s: 发送 `EVENT:VGA_READY`
- T+3.0s: 发送 `EVENT:HD_READY`

**当前实现：**
- ✅ 固件中有UDP事件发送
- ⚠️ 需要确认App端UDP监听是否正确处理时序

**建议：**
- 添加UDP事件接收日志，确认时序正确
- 处理UDP丢包情况（超时重试机制）

### 5. **秘书AI触发条件** ⚠️ 需要优化

**工作逻辑要求：**
- 触发：当 [First_Command] 和 [图A] 就绪时

**当前实现：**
- ✅ 在 `_handleVgaReady()` 中调用 `_processSecretaryAi()`
- ⚠️ 但First_Command可能还未准备好（如果用户说话很慢）

**建议：**
- 添加等待机制：如果First_Command未就绪，等待最多2秒
- 如果超时，使用默认文本"帮我看下这个"

### 6. **专家AI触发条件** ✅ 基本正确

**工作逻辑要求：**
- 触发：当 [Full_Context]、[图B] 和 秘书指令 就绪时

**当前实现：**
- ✅ 在 `_handleHdReady()` 中调用 `_processExpertAi()`
- ✅ 使用Full_Context和secretary_context

### 7. **本地存储同步策略** ✅ 已实现

**工作逻辑要求：**
- 未明确说明，但已实现本地优先存储

**当前实现：**
- ✅ SQLite本地数据库
- ✅ 后台异步同步
- ✅ 非工作时段自动同步

---

## 📋 补充建议

### 1. **错误处理和重试机制**
- 添加UDP事件丢失的重试机制
- 添加图像获取失败的重试（最多3次）
- 添加AI调用失败的回退策略

### 2. **性能优化**
- 图像裁剪使用异步处理，不阻塞主线程
- AI调用添加超时控制（已实现30秒）
- 本地数据库操作使用事务批量处理

### 3. **用户体验增强**
- 添加连拍模式的视觉提示（激光闪烁模式）
- 添加处理进度显示（VGA就绪、HD就绪、AI处理中）
- 添加离线模式提示（当后端不可用时）

### 4. **调试和监控**
- 添加详细的时间戳日志（T+0.0s, T+0.6s等）
- 添加性能指标记录（图像获取耗时、AI响应时间）
- 添加错误统计（UDP丢包率、图像获取失败率）

---

## 🎯 优先级建议

### 高优先级（必须实现）
1. **连拍功能** - 工作逻辑明确要求，但完全缺失
2. **UDP事件处理验证** - 确保时序正确
3. **秘书AI触发优化** - 确保First_Command就绪

### 中优先级（建议实现）
1. 音频静默检测优化
2. 错误处理和重试机制
3. 性能监控和日志

### 低优先级（可选）
1. 用户体验增强
2. 调试工具完善

---

## 📝 总结

**整体评估：** 工作流程基本正确，核心功能已实现，但**连拍功能完全缺失**，这是最重要的遗漏。

**主要问题：**
1. ❌ 连拍功能未实现（高优先级）
2. ⚠️ 秘书AI触发时序可能需要优化
3. ⚠️ UDP事件处理需要验证

**建议下一步：**
1. 立即实现连拍功能
2. 添加端到端测试，验证完整工作流程
3. 优化错误处理和用户体验


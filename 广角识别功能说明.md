# 广角识别功能说明

## ✅ 实现内容

### 1. 秘书AI广角关键词识别
- ✅ 修改了 `backend/src/core/prompts/secretary.js`，增加了广角关键词识别规则
- ✅ 支持的关键词：
  - "整体"、"这片"、"全景"、"全部"、"整个"
  - "全貌"、"大范围"、"周围"、"环境"
- ✅ 当检测到这些关键词时，`camera_action` 自动设为 `"wide"`

### 2. 图像选择逻辑
- ✅ 在 `mobile_app/lib/screens/home_screen.dart` 中已实现：
  - `camera_action == "wide"` → 使用 `cacheB`（未裁剪的原图）
  - `camera_action == "normal"` → 使用 `cacheC`（裁剪图，540x720），如果没有则使用 `cacheB`

### 3. 优先级规则
- ✅ 优先使用AI判断的 `camera_action`（基于用户提示词）
- ✅ 如果AI未明确设置，则根据专家类型回退：
  - `travel`、`fengshui`、`detective` → `"wide"`
  - 其他 → `"normal"`

## 📋 工作流程

1. **用户输入**：用户说"看看这片的整体情况"
2. **秘书AI分析**：
   - 检测到关键词"整体"、"这片"
   - 返回 `camera_action: "wide"`
3. **图像选择**：
   - App收到 `camera_action: "wide"`
   - 在调用专家AI时，使用 `cacheB`（原图，未裁剪）
4. **专家AI分析**：基于完整原图进行分析

## 🔧 关键代码位置

### 后端
- `backend/src/core/prompts/secretary.js`:
  - 增加了 `camera_action` 规则说明
  - 增加了示例（包含广角场景）

- `backend/src/services/ai/secretaryAI.js`:
  - 优先使用AI返回的 `camera_action`
  - 如果没有，则根据专家类型回退

### App端
- `mobile_app/lib/screens/home_screen.dart`:
  - `_processExpertAi()` 中的图像选择逻辑
  - `picRequire == 'wide'` → `cacheB`
  - `picRequire == 'normal'` → `cacheC ?? cacheB`

## 🎯 测试场景

1. **明确广角需求**：
   - 用户："看看这片的整体情况"
   - 预期：`camera_action = "wide"`，使用原图

2. **模糊广角需求**：
   - 用户："帮我看看周围的环境"
   - 预期：`camera_action = "wide"`，使用原图

3. **正常需求**：
   - 用户："分析这个零件"
   - 预期：`camera_action = "normal"`，使用裁剪图

4. **专家类型回退**：
   - 用户："看看这个房间"（未明确说整体）
   - 专家：`fengshui`
   - 预期：`camera_action = "wide"`（根据专家类型）

## 📝 注意事项

1. **关键词识别**：AI会智能识别用户意图，不仅限于列出的关键词
2. **优先级**：AI判断 > 专家类型回退
3. **图像质量**：原图（cacheB）包含完整信息，适合分析整体、环境等场景
4. **裁剪图**：裁剪图（cacheC）聚焦中心区域，适合分析细节、零件等场景


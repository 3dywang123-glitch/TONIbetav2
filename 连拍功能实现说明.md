# è¿æ‹åŠŸèƒ½å®ç°è¯´æ˜

## âœ… å·²å®ç°åŠŸèƒ½

### 1. åç«¯ç§˜ä¹¦AIåˆ¤æ–­è¿æ‹éœ€æ±‚
- âœ… ä¿®æ”¹äº† `backend/src/core/prompts/secretary.js`ï¼Œå¢åŠ è¿æ‹åˆ¤æ–­è§„åˆ™
- âœ… ä¿®æ”¹äº† `backend/src/services/ai/secretaryAI.js`ï¼Œè¿”å› `burst_count` å­—æ®µï¼ˆ0-9ï¼‰
- âœ… è§„åˆ™ï¼š
  - ç”¨æˆ·æ˜ç¡®è¦æ±‚å¤šå¼ ï¼ˆå¦‚"æ‹5å¼ "ï¼‰â†’ è¿”å›å…·ä½“æ•°é‡
  - æ¨¡ç³Šè¡¨è¾¾ï¼ˆå¦‚"çœ‹çœ‹è¿™å‡ é¡µ"ã€"å¤šæ‹ç‚¹"ï¼‰â†’ è¿”å›9ï¼ˆæœ€å¤§å€¼ï¼‰
  - å•å¼ æˆ–ä¸éœ€è¦ â†’ è¿”å›0

### 2. Appç«¯è¿æ‹æµç¨‹æ§åˆ¶
- âœ… æ‰©å±•äº† `ImageCacheService`ï¼Œæ”¯æŒå¤šå¼ è¿æ‹å›¾åƒå­˜å‚¨
- âœ… æ·»åŠ äº† `CaptureState.bursting` çŠ¶æ€
- âœ… å®ç°äº† `_startBurstSequence()` è¿æ‹åºåˆ—æ§åˆ¶
- âœ… å®ç°äº† `_monitorBurstInterrupt()` ç›‘å¬ç”¨æˆ·ä¸­æ–­æŒ‡ä»¤
- âœ… å®ç°äº† `_waitForBurstImages()` ç­‰å¾…è¿æ‹å›¾åƒæ¥æ”¶
- âœ… æ”¯æŒç”¨æˆ·éšæ—¶è¯´"å¥½äº†"ã€"åœæ­¢"ã€"å¤Ÿäº†"ç­‰ä¸­æ–­è¿æ‹

### 3. ä¸“å®¶AIå¤šå›¾åƒæ”¯æŒ
- âœ… ä¿®æ”¹äº† `backend/src/routes/expert.js`ï¼Œæ”¯æŒ `burst_images` å‚æ•°
- âœ… ä¿®æ”¹äº† `backend/src/services/ai/expertAI.js`ï¼Œæ”¯æŒå¤šå¼ å›¾åƒè¾“å…¥
- âœ… ä¿®æ”¹äº† `AiService.callExpertAi()`ï¼Œä¼ é€’è¿æ‹å›¾åƒåˆ—è¡¨
- âœ… ä¸“å®¶AIå¯ä»¥åŒæ—¶åˆ†æå¤šå¼ è¿æ‹å›¾åƒ

### 4. HTTPå®¢æˆ·ç«¯è¿æ‹æ¥å£
- âœ… åœ¨ `HttpClientService` ä¸­æ·»åŠ äº† `triggerBurst()` æ–¹æ³•
- âœ… æ”¯æŒè°ƒç”¨ `GET /burst?count=N` è§¦å‘è¿æ‹

## âš ï¸ å¾…å®ç°ï¼ˆå›ºä»¶ç«¯ï¼‰

### å›ºä»¶ `/burst` æ¥å£
éœ€è¦åœ¨ `xiao_esp32s3_sence.txt` ä¸­æ·»åŠ ï¼š

```cpp
// åœ¨ HTTP æœåŠ¡å™¨è·¯ç”±ä¸­æ·»åŠ 
server.on("/burst", HTTP_GET, [](){
  int count = server.arg("count").toInt();
  if (count > 0 && count <= 9) {
    // è§¦å‘è¿æ‹åºåˆ—
    burstCount = count;
    burstState = BURST_START;
    server.send(200, "text/plain", "OK");
  } else {
    server.send(400, "text/plain", "Invalid count");
  }
});
```

è¿æ‹é€»è¾‘å»ºè®®ï¼š
- æ¥æ”¶åˆ° `/burst?count=N` åï¼Œè¿ç»­æ‹æ‘„Nå¼ QXGAå›¾åƒ
- æ¯å¼ å›¾åƒæ‹æ‘„å®Œæˆåï¼Œå‘é€ `EVENT:HD_READY` UDPäº‹ä»¶
- Appç«¯é€šè¿‡ç›‘å¬å¤šä¸ª `EVENT:HD_READY` äº‹ä»¶æ¥è·å–æ‰€æœ‰è¿æ‹å›¾åƒ

## ğŸ“‹ å·¥ä½œæµç¨‹

### æ­£å¸¸æµç¨‹
1. ç”¨æˆ·è§¦å‘æ‹æ‘„ â†’ T+0.0s
2. è·å–VGAå›¾ â†’ T+0.6s
3. ç§˜ä¹¦AIåˆ¤æ–­æ˜¯å¦éœ€è¦è¿æ‹ â†’ è¿”å› `burst_count`
4. è·å–ç¬¬ä¸€å¼ HDå›¾ â†’ T+3.0s
5. **å¦‚æœéœ€è¦è¿æ‹ï¼ˆburst_count > 0ï¼‰**ï¼š
   - è¿›å…¥ `bursting` çŠ¶æ€
   - è°ƒç”¨ `GET /burst?count=N-1`ï¼ˆç¬¬ä¸€å¼ å·²æ‹ï¼Œè¿˜éœ€N-1å¼ ï¼‰
   - ç›‘å¬å¤šä¸ª `EVENT:HD_READY` äº‹ä»¶
   - æ¥æ”¶å¹¶å­˜å‚¨æ‰€æœ‰è¿æ‹å›¾åƒ
6. è°ƒç”¨ä¸“å®¶AIï¼Œä¼ é€’æ‰€æœ‰å›¾åƒï¼ˆç¬¬ä¸€å¼  + è¿æ‹å›¾åƒï¼‰

### ä¸­æ–­æµç¨‹
- ç”¨æˆ·åœ¨è¿æ‹è¿‡ç¨‹ä¸­è¯´"å¥½äº†"ã€"åœæ­¢"ç­‰
- Appæ£€æµ‹åˆ°ä¸­æ–­æŒ‡ä»¤åï¼š
  - ç«‹å³åœæ­¢ç­‰å¾…è¿æ‹
  - ä½¿ç”¨å·²æ¥æ”¶çš„å›¾åƒè°ƒç”¨ä¸“å®¶AI
  - æ›´æ–° `burstCount` ä¸ºå®é™…æ¥æ”¶æ•°é‡

## ğŸ”§ å…³é”®ä»£ç ä½ç½®

### Appç«¯
- `mobile_app/lib/screens/home_screen.dart`:
  - `_processSecretaryAi()` - å¤„ç†ç§˜ä¹¦AIè¿”å›ï¼Œæ£€æŸ¥burst_count
  - `_handleHdReady()` - HDå›¾å°±ç»ªååˆ¤æ–­æ˜¯å¦éœ€è¦è¿æ‹
  - `_startBurstSequence()` - å¼€å§‹è¿æ‹åºåˆ—
  - `_monitorBurstInterrupt()` - ç›‘å¬ä¸­æ–­æŒ‡ä»¤
  - `_waitForBurstImages()` - ç­‰å¾…è¿æ‹å›¾åƒ
  - `_isInterruptCommand()` - æ£€æŸ¥æ˜¯å¦ä¸ºä¸­æ–­æŒ‡ä»¤
  - `_interruptBurst()` - ä¸­æ–­è¿æ‹

- `mobile_app/lib/services/image/image_cache_service.dart`:
  - `addBurstImage()` - æ·»åŠ è¿æ‹å›¾åƒ
  - `getAllExpertImages()` - è·å–æ‰€æœ‰å›¾åƒï¼ˆç”¨äºä¸“å®¶AIï¼‰

- `mobile_app/lib/services/ai/ai_service.dart`:
  - `burstCount` å±æ€§ - å­˜å‚¨è¿æ‹æ•°é‡
  - `callExpertAi()` - æ”¯æŒ `burstImages` å‚æ•°

### åç«¯
- `backend/src/core/prompts/secretary.js`:
  - è¿æ‹åˆ¤æ–­è§„åˆ™è¯´æ˜

- `backend/src/services/ai/secretaryAI.js`:
  - è§£æå¹¶è¿”å› `burst_count`

- `backend/src/services/ai/expertAI.js`:
  - æ”¯æŒå¤šå¼ å›¾åƒè¾“å…¥

- `backend/src/routes/expert.js`:
  - æ¥æ”¶ `burst_images` å‚æ•°

## ğŸ¯ æµ‹è¯•è¦ç‚¹

1. **å•å¼ æ‹æ‘„**ï¼šburst_count = 0ï¼Œæ­£å¸¸æµç¨‹
2. **æ˜ç¡®è¿æ‹**ï¼šç”¨æˆ·è¯´"æ‹5å¼ "ï¼Œburst_count = 5
3. **æ¨¡ç³Šè¿æ‹**ï¼šç”¨æˆ·è¯´"çœ‹çœ‹è¿™å‡ é¡µ"ï¼Œburst_count = 9
4. **ä¸­æ–­æµ‹è¯•**ï¼šè¿æ‹è¿‡ç¨‹ä¸­è¯´"å¥½äº†"ï¼Œç«‹å³åœæ­¢å¹¶è°ƒç”¨ä¸“å®¶AI
5. **è¶…æ—¶å¤„ç†**ï¼šè¿æ‹å›¾åƒæ¥æ”¶è¶…æ—¶ï¼Œä½¿ç”¨å·²æ¥æ”¶å›¾åƒç»§ç»­

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç¬¬ä¸€å¼ HDå›¾**ï¼šT+3.0sæ‹æ‘„çš„ç¬¬ä¸€å¼ HDå›¾ä¼šè‡ªåŠ¨åŠ å…¥è¿æ‹åˆ—è¡¨ï¼ˆç´¢å¼•0ï¼‰
2. **è¿æ‹æ•°é‡**ï¼šæœ€å¤š9å¼ ï¼ˆåŒ…æ‹¬ç¬¬ä¸€å¼ ï¼‰ï¼Œå›ºä»¶éœ€è¦é™åˆ¶
3. **ä¸­æ–­æŒ‡ä»¤**ï¼šæ”¯æŒ"å¥½äº†"ã€"åœæ­¢"ã€"å¤Ÿäº†"ã€"å®Œæˆ"ã€"å¯ä»¥äº†"ã€"stop"ã€"done"ã€"ok"
4. **UDPäº‹ä»¶**ï¼šæ¯å¼ è¿æ‹å›¾åƒéƒ½éœ€è¦å‘é€ `EVENT:HD_READY` äº‹ä»¶
5. **å›¾åƒé¡ºåº**ï¼šè¿æ‹å›¾åƒæŒ‰æ¥æ”¶é¡ºåºå­˜å‚¨ï¼Œä¸“å®¶AIæŒ‰é¡ºåºåˆ†æ


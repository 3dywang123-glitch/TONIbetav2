# ç¡®è®¤å’Œé‡è¯•æœºåˆ¶å®ç°è¯´æ˜

## âœ… Appç«¯å·²å®ç°

### 1. UDPäº‹ä»¶ç¡®è®¤æœºåˆ¶ âœ…

**å®ç°ä½ç½®**: `mobile_app/lib/services/network/udp_event_service.dart`

**åŠŸèƒ½**:
- Appæ”¶åˆ°UDPäº‹ä»¶ï¼ˆ`EVENT:VGA_READY` æˆ– `EVENT:HD_READY`ï¼‰åï¼Œç«‹å³å‘é€ç¡®è®¤æ¶ˆæ¯
- ç¡®è®¤æ¶ˆæ¯æ ¼å¼ï¼š`ACK:VGA_READY` æˆ– `ACK:HD_READY`
- é€šè¿‡ç‹¬ç«‹çš„UDP socketå‘é€ç¡®è®¤ï¼Œä¸é˜»å¡ä¸»æµç¨‹

**ä»£ç **:
```dart
void _processEvent(String message) {
  if (message == 'EVENT:VGA_READY') {
    _eventController.add('VGA_READY');
    sendAck('VGA_READY'); // è‡ªåŠ¨å‘é€ç¡®è®¤
    notifyListeners();
  } else if (message == 'EVENT:HD_READY') {
    _eventController.add('HD_READY');
    sendAck('HD_READY'); // è‡ªåŠ¨å‘é€ç¡®è®¤
    notifyListeners();
  }
}
```

### 2. å›¾åƒä¼ è¾“ç¡®è®¤æœºåˆ¶ âœ…

**å®ç°ä½ç½®**: `mobile_app/lib/services/network/http_client_service.dart`

**åŠŸèƒ½**:
- AppæˆåŠŸè·å–å›¾åƒåï¼Œè‡ªåŠ¨å‘é€ç¡®è®¤æ¶ˆæ¯åˆ°è®¾å¤‡
- ç¡®è®¤æ¥å£ï¼š`GET /ack_image?type=VGA` æˆ– `GET /ack_image?type=HD`
- ç¡®è®¤å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼ˆåªè®°å½•æ—¥å¿—ï¼‰

**ä»£ç **:
```dart
if (response.statusCode == 200) {
  final imageData = response.bodyBytes;
  debugPrint('$imageType image fetched: ${imageData.length} bytes');
  
  // å‘é€ç¡®è®¤æ¶ˆæ¯
  await _sendImageAck(deviceIp, endpoint);
  
  return imageData;
}
```

### 3. è¿æ‹è§¦å‘é‡è¯•æœºåˆ¶ âœ…

**å®ç°ä½ç½®**: `mobile_app/lib/services/network/http_client_service.dart`

**åŠŸèƒ½**:
- `triggerBurst()` æ–¹æ³•æ”¯æŒæœ€å¤š3æ¬¡é‡è¯•
- æ¯æ¬¡é‡è¯•é—´éš”500ms
- ä¸ `triggerCapture()` ä¿æŒä¸€è‡´çš„é‡è¯•ç­–ç•¥

**ä»£ç **:
```dart
Future<bool> triggerBurst(String deviceIp, int count) async {
  // é‡è¯•æœ€å¤š3æ¬¡
  for (int attempt = 0; attempt < 3; attempt++) {
    // ... é‡è¯•é€»è¾‘ ...
  }
}
```

### 4. å›¾åƒè·å–é‡è¯•æœºåˆ¶ âœ…

**å®ç°ä½ç½®**: `mobile_app/lib/services/network/http_client_service.dart`

**åŠŸèƒ½**:
- VGAå’ŒHDå›¾åƒè·å–éƒ½æ”¯æŒæœ€å¤š3æ¬¡é‡è¯•
- 404é”™è¯¯ï¼ˆå›¾åƒæœªå°±ç»ªï¼‰ä¼šç­‰å¾…åé‡è¯•
- ç½‘ç»œé”™è¯¯ä¼šå»¶è¿Ÿåé‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰

### 5. è§¦å‘æŒ‡ä»¤é‡è¯•æœºåˆ¶ âœ…

**å®ç°ä½ç½®**: `mobile_app/lib/services/network/http_client_service.dart`

**åŠŸèƒ½**:
- `triggerCapture()` æ”¯æŒæœ€å¤š3æ¬¡é‡è¯•
- æ¯æ¬¡é‡è¯•é—´éš”500ms

---

## âš ï¸ è®¾å¤‡ç«¯å¾…å®ç°

### 1. UDPäº‹ä»¶é‡è¯•æœºåˆ¶ âš ï¸

**éœ€è¦å®ç°**:
- è®¾å¤‡å‘é€UDPäº‹ä»¶åï¼Œç­‰å¾…Appçš„ç¡®è®¤æ¶ˆæ¯
- å¦‚æœ1ç§’å†…æœªæ”¶åˆ°ç¡®è®¤ï¼Œé‡å‘UDPäº‹ä»¶
- æœ€å¤šé‡è¯•3æ¬¡

**å‚è€ƒå®ç°**: è§ `è®¾å¤‡ç«¯ç¡®è®¤æœºåˆ¶è¯´æ˜.md`

### 2. UDPç¡®è®¤æ¶ˆæ¯å¤„ç† âš ï¸

**éœ€è¦å®ç°**:
- åœ¨UDPç›‘å¬ä¸­å¤„ç† `ACK:VGA_READY` å’Œ `ACK:HD_READY` æ¶ˆæ¯
- æ”¶åˆ°ç¡®è®¤åï¼Œåœæ­¢é‡è¯•è®¡æ—¶å™¨

### 3. å›¾åƒæ¥æ”¶ç¡®è®¤æ¥å£ âš ï¸

**éœ€è¦å®ç°**:
- æ·»åŠ  `/ack_image` HTTPæ¥å£
- æ¥æ”¶Appçš„å›¾åƒæ¥æ”¶ç¡®è®¤
- ç”¨äºç»Ÿè®¡å’Œæ—¥å¿—è®°å½•

**å‚è€ƒå®ç°**:
```cpp
server.on("/ack_image", HTTP_GET, [](){
  String type = server.arg("type"); // "VGA" æˆ– "HD"
  Serial.println("âœ… æ”¶åˆ°å›¾åƒç¡®è®¤: " + type);
  server.send(200, "text/plain", "OK");
});
```

### 4. App IPåœ°å€è®°å½• âš ï¸

**éœ€è¦å®ç°**:
- åœ¨ `/trigger` æ¥å£ä¸­è®°å½•Appçš„IPåœ°å€
- ç”¨äºåç»­UDPäº‹ä»¶å‘é€ï¼ˆç¡®ä¿èƒ½æ­£ç¡®å‘é€åˆ°Appï¼‰

**å‚è€ƒå®ç°**:
```cpp
IPAddress appIP;
uint16_t appPort;

server.on("/trigger", HTTP_GET, [](){
  WiFiClient client = server.client();
  appIP = client.remoteIP();
  appPort = client.remotePort();
  // ...
});
```

---

## ğŸ“Š å®Œæ•´ç¡®è®¤æµç¨‹

### UDPäº‹ä»¶ç¡®è®¤æµç¨‹

```
1. è®¾å¤‡å‘é€ EVENT:VGA_READY
   â†“
2. Appæ”¶åˆ°äº‹ä»¶ï¼Œç«‹å³å‘é€ ACK:VGA_READY
   â†“
3. è®¾å¤‡æ”¶åˆ°ç¡®è®¤ï¼Œåœæ­¢é‡è¯•è®¡æ—¶å™¨
   â†“
4. å¦‚æœ1ç§’å†…æœªæ”¶åˆ°ç¡®è®¤ï¼Œè®¾å¤‡é‡å‘äº‹ä»¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
```

### å›¾åƒä¼ è¾“ç¡®è®¤æµç¨‹

```
1. Appè¯·æ±‚ GET /latest_vga
   â†“
2. è®¾å¤‡è¿”å›å›¾åƒæ•°æ®ï¼ˆHTTP 200ï¼‰
   â†“
3. Appæ”¶åˆ°å›¾åƒï¼Œå‘é€ GET /ack_image?type=VGA
   â†“
4. è®¾å¤‡è®°å½•ç¡®è®¤ï¼ˆç”¨äºç»Ÿè®¡å’Œæ—¥å¿—ï¼‰
```

---

## ğŸ”§ å…³é”®æ”¹è¿›ç‚¹

### 1. å¯é æ€§æå‡
- âœ… æ‰€æœ‰HTTPè¯·æ±‚éƒ½æœ‰é‡è¯•æœºåˆ¶
- âœ… UDPäº‹ä»¶æœ‰ç¡®è®¤æœºåˆ¶ï¼ˆAppç«¯å·²å®ç°ï¼‰
- âš ï¸ è®¾å¤‡ç«¯UDPé‡è¯•æœºåˆ¶å¾…å®ç°

### 2. é”™è¯¯å¤„ç†
- âœ… ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•
- âœ… 404é”™è¯¯ï¼ˆæœªå°±ç»ªï¼‰ç­‰å¾…åé‡è¯•
- âœ… è¶…æ—¶ä¿æŠ¤æœºåˆ¶

### 3. ç¡®è®¤æœºåˆ¶
- âœ… Appç«¯è‡ªåŠ¨å‘é€ç¡®è®¤
- âš ï¸ è®¾å¤‡ç«¯ç¡®è®¤å¤„ç†å¾…å®ç°
- âš ï¸ è®¾å¤‡ç«¯é‡è¯•æœºåˆ¶å¾…å®ç°

---

## ğŸ“‹ æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯

1. **æ­£å¸¸æµç¨‹**
   - éªŒè¯UDPäº‹ä»¶ç¡®è®¤æ˜¯å¦æ­£å¸¸å‘é€
   - éªŒè¯å›¾åƒç¡®è®¤æ˜¯å¦æ­£å¸¸å‘é€

2. **ç½‘ç»œæ³¢åŠ¨**
   - æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿï¼ŒéªŒè¯é‡è¯•æœºåˆ¶
   - æ¨¡æ‹ŸUDPä¸¢åŒ…ï¼ŒéªŒè¯ç¡®è®¤æœºåˆ¶

3. **è®¾å¤‡ç«¯é‡è¯•**
   - æ¨¡æ‹ŸAppæœªæ”¶åˆ°UDPäº‹ä»¶ï¼ŒéªŒè¯è®¾å¤‡é‡è¯•
   - éªŒè¯é‡è¯•æ¬¡æ•°é™åˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰

---

## ğŸ¯ ä¼˜å…ˆçº§

**é«˜ä¼˜å…ˆçº§**ï¼ˆå¿…é¡»å®ç°ï¼‰:
1. è®¾å¤‡ç«¯UDPäº‹ä»¶é‡è¯•æœºåˆ¶
2. App IPåœ°å€è®°å½•

**ä¸­ä¼˜å…ˆçº§**ï¼ˆå»ºè®®å®ç°ï¼‰:
1. UDPç¡®è®¤æ¶ˆæ¯å¤„ç†
2. `/ack_image` æ¥å£

**ä½ä¼˜å…ˆçº§**ï¼ˆå¯é€‰ï¼‰:
1. ç¡®è®¤ç»Ÿè®¡å’Œæ—¥å¿—
2. æ€§èƒ½ç›‘æ§

---

## ğŸ“ æ€»ç»“

**Appç«¯**: âœ… å·²å®Œæˆæ‰€æœ‰ç¡®è®¤å’Œé‡è¯•æœºåˆ¶
- UDPäº‹ä»¶ç¡®è®¤ âœ…
- å›¾åƒä¼ è¾“ç¡®è®¤ âœ…
- æ‰€æœ‰HTTPè¯·æ±‚é‡è¯• âœ…

**è®¾å¤‡ç«¯**: âš ï¸ éœ€è¦å®ç°ç¡®è®¤æ¥æ”¶å’Œé‡è¯•æœºåˆ¶
- UDPäº‹ä»¶é‡è¯• âš ï¸
- UDPç¡®è®¤å¤„ç† âš ï¸
- å›¾åƒç¡®è®¤æ¥å£ âš ï¸
- App IPè®°å½• âš ï¸

æ‰€æœ‰Appç«¯ä»£ç å·²é€šè¿‡linteræ£€æŸ¥ï¼Œæ— é”™è¯¯ã€‚


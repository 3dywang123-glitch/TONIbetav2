# æ‹ç…§æµç¨‹æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ å®Œæ•´æµç¨‹åˆ†æ

### å½“å‰å®ç°æµç¨‹

#### 1. ç”¨æˆ·æŒ‰ä¸‹æŒ‰é’®
- **ä½ç½®**: `CaptureButtonWidget` â†’ `HomeScreen._triggerCapture()`
- **è§¦å‘**: ç”¨æˆ·ç‚¹å‡»æ‹æ‘„æŒ‰é’®
- **çŠ¶æ€**: âœ… å·²å®ç°

#### 2. Appå‘é€è§¦å‘æŒ‡ä»¤
- **ä½ç½®**: `HttpClientService.triggerCapture()`
- **åŠ¨ä½œ**: `GET http://{deviceIp}/trigger`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **é—®é¢˜**: âš ï¸ å¦‚æœè§¦å‘å¤±è´¥ï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶

#### 3. è®¾å¤‡å¼€å§‹æ‹æ‘„åºåˆ—
- **ä½ç½®**: å›ºä»¶ `runAutonomousSequence()`
- **æ—¶åº**:
  - T+0.0s: æ”¶åˆ°è§¦å‘æŒ‡ä»¤ï¼Œå¼€å§‹åºåˆ—
  - T+0.1s: çƒ­æœºVGAï¼ˆå†…éƒ¨é”€æ¯ï¼‰
  - T+0.6s: æ‹æ‘„VGAï¼Œå‘é€ `EVENT:VGA_READY` UDPäº‹ä»¶
  - T+2.0s: çƒ­æœºQXGAï¼ˆå†…éƒ¨é”€æ¯ï¼‰
  - T+3.0s: æ‹æ‘„QXGAï¼Œå‘é€ `EVENT:HD_READY` UDPäº‹ä»¶
- **çŠ¶æ€**: âœ… å·²å®ç°ï¼ˆæ ¹æ®å›ºä»¶ä»£ç ï¼‰

#### 4. Appç›‘å¬UDPäº‹ä»¶
- **ä½ç½®**: `UdpEventService.startListening()`
- **åˆå§‹åŒ–**: åœ¨ `_initializeServices()` ä¸­å¯åŠ¨
- **ç›‘å¬**: æŒç»­ç›‘å¬ç«¯å£8888çš„UDPæ¶ˆæ¯
- **çŠ¶æ€**: âœ… å·²å®ç°
- **é—®é¢˜**: âš ï¸ å¦‚æœUDPäº‹ä»¶ä¸¢å¤±ï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶

#### 5. è‡ªåŠ¨è·å–VGAå›¾åƒ
- **ä½ç½®**: `_handleVgaReady()` â†’ `HttpClientService.fetchVgaImage()`
- **è§¦å‘**: æ”¶åˆ° `EVENT:VGA_READY` UDPäº‹ä»¶
- **åŠ¨ä½œ**: è‡ªåŠ¨è°ƒç”¨ `GET http://{deviceIp}/latest_vga`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **é—®é¢˜**: âš ï¸ å¦‚æœè·å–å¤±è´¥ï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶

#### 6. è‡ªåŠ¨å¤„ç†ç§˜ä¹¦AI
- **ä½ç½®**: `_processSecretaryAi()`
- **è§¦å‘**: VGAå›¾åƒè·å–æˆåŠŸåè‡ªåŠ¨è°ƒç”¨
- **çŠ¶æ€**: âœ… å·²å®ç°

#### 7. è‡ªåŠ¨è·å–HDå›¾åƒ
- **ä½ç½®**: `_handleHdReady()` â†’ `HttpClientService.fetchHdImage()`
- **è§¦å‘**: æ”¶åˆ° `EVENT:HD_READY` UDPäº‹ä»¶
- **åŠ¨ä½œ**: è‡ªåŠ¨è°ƒç”¨ `GET http://{deviceIp}/latest_hd`
- **çŠ¶æ€**: âœ… å·²å®ç°
- **é—®é¢˜**: âš ï¸ å¦‚æœè·å–å¤±è´¥ï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶

#### 8. è‡ªåŠ¨å¤„ç†ä¸“å®¶AI
- **ä½ç½®**: `_processExpertAi()`
- **è§¦å‘**: HDå›¾åƒè·å–æˆåŠŸåè‡ªåŠ¨è°ƒç”¨
- **çŠ¶æ€**: âœ… å·²å®ç°

---

## âœ… æµç¨‹å®Œæ•´æ€§æ£€æŸ¥

### å·²æ­£ç¡®å®ç°çš„éƒ¨åˆ†

1. **æŒ‰é’®è§¦å‘** âœ…
   - ç”¨æˆ·æŒ‰ä¸‹æŒ‰é’® â†’ `_triggerCapture()` è¢«è°ƒç”¨
   - è‡ªåŠ¨å‘é€ `GET /trigger` åˆ°è®¾å¤‡

2. **UDPäº‹ä»¶ç›‘å¬** âœ…
   - åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶å¯åŠ¨UDPç›‘å¬
   - æŒç»­ç›‘å¬ç«¯å£8888
   - è‡ªåŠ¨å¤„ç† `EVENT:VGA_READY` å’Œ `EVENT:HD_READY`

3. **è‡ªåŠ¨å›¾åƒè·å–** âœ…
   - æ”¶åˆ°UDPäº‹ä»¶åè‡ªåŠ¨è·å–å›¾åƒ
   - æ— éœ€ç”¨æˆ·é¢å¤–æ“ä½œ

4. **è‡ªåŠ¨AIå¤„ç†** âœ…
   - VGAå›¾åƒè·å–åè‡ªåŠ¨è°ƒç”¨ç§˜ä¹¦AI
   - HDå›¾åƒè·å–åè‡ªåŠ¨è°ƒç”¨ä¸“å®¶AI

---

## âš ï¸ æ½œåœ¨é—®é¢˜å’Œæ”¹è¿›å»ºè®®

### 1. UDPäº‹ä»¶ä¸¢å¤±å¤„ç† âš ï¸ é‡è¦

**é—®é¢˜**:
- UDPæ˜¯æ— è¿æ¥åè®®ï¼Œå¯èƒ½ä¸¢åŒ…
- å¦‚æœ `EVENT:VGA_READY` æˆ– `EVENT:HD_READY` ä¸¢å¤±ï¼ŒAppä¸ä¼šè·å–å›¾åƒ
- ç”¨æˆ·éœ€è¦é‡æ–°æ‹æ‘„

**å»ºè®®å®ç°**:
```dart
// åœ¨ _handleVgaReady() å’Œ _handleHdReady() ä¸­æ·»åŠ è¶…æ—¶é‡è¯•
Future<void> _handleVgaReady() async {
  // å¦‚æœ5ç§’å†…æ²¡æ”¶åˆ°UDPäº‹ä»¶ï¼Œä¸»åŠ¨è½®è¯¢
  await Future.delayed(Duration(seconds: 5));
  if (imageCache.cacheA == null) {
    // ä¸»åŠ¨è·å–VGAå›¾åƒï¼ˆå³ä½¿æ²¡æ”¶åˆ°UDPäº‹ä»¶ï¼‰
    await _fetchVgaWithRetry();
  }
}
```

### 2. å›¾åƒè·å–å¤±è´¥é‡è¯• âš ï¸ é‡è¦

**é—®é¢˜**:
- å¦‚æœ `GET /latest_vga` æˆ– `GET /latest_hd` å¤±è´¥ï¼Œæ²¡æœ‰é‡è¯•
- ç”¨æˆ·éœ€è¦é‡æ–°æ‹æ‘„

**å»ºè®®å®ç°**:
```dart
Future<Uint8List?> fetchVgaImageWithRetry(String deviceIp, {int maxRetries = 3}) async {
  for (int i = 0; i < maxRetries; i++) {
    final image = await fetchVgaImage(deviceIp);
    if (image != null) return image;
    await Future.delayed(Duration(seconds: 1));
  }
  return null;
}
```

### 3. è§¦å‘æŒ‡ä»¤å¤±è´¥å¤„ç† âš ï¸ å»ºè®®

**é—®é¢˜**:
- å¦‚æœ `GET /trigger` å¤±è´¥ï¼Œç”¨æˆ·ä¸çŸ¥é“
- æ²¡æœ‰é‡è¯•æœºåˆ¶

**å»ºè®®å®ç°**:
- æ˜¾ç¤ºé”™è¯¯æç¤º
- è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰

### 4. UDPäº‹ä»¶ç›‘å¬å¯åŠ¨æ—¶æœº âš ï¸ éœ€è¦éªŒè¯

**å½“å‰å®ç°**:
- åœ¨ `_initializeServices()` ä¸­å¯åŠ¨
- åœ¨è®¾å¤‡å‘ç°åå¯åŠ¨

**æ½œåœ¨é—®é¢˜**:
- å¦‚æœè®¾å¤‡åœ¨åº”ç”¨å¯åŠ¨åæ‰è¿æ¥ï¼ŒUDPç›‘å¬å¯èƒ½æœªå¯åŠ¨
- éœ€è¦ç¡®ä¿è®¾å¤‡è¿æ¥åç«‹å³å¯åŠ¨UDPç›‘å¬

**å½“å‰ä»£ç æ£€æŸ¥**:
```dart
// åœ¨ discovery.addListener() ä¸­å·²å¤„ç†
discovery.addListener(() {
  if (discovery.currentDevice != null && mounted) {
    udpEvents.setDeviceIp(discovery.currentDevice!.ip);
    udpEvents.startListening();  // âœ… å·²å®ç°
    _setupEventHandlers(udpEvents);
  }
});
```
âœ… è¿™éƒ¨åˆ†å·²æ­£ç¡®å®ç°

### 5. å›ºä»¶UDPå‘é€ç›®æ ‡ âš ï¸ éœ€è¦ç¡®è®¤

**å›ºä»¶ä»£ç **:
```cpp
Udp.beginPacket(Udp.remoteIP(), Udp.remotePort());
```

**é—®é¢˜**:
- `Udp.remoteIP()` å’Œ `Udp.remotePort()` éœ€è¦çŸ¥é“Appçš„IPå’Œç«¯å£
- å¦‚æœAppä»æœªå‘é€è¿‡UDPæ¶ˆæ¯ï¼Œå›ºä»¶å¯èƒ½ä¸çŸ¥é“Appçš„IP

**å»ºè®®**:
- åœ¨è®¾å¤‡å‘ç°æ—¶ï¼ŒAppåº”è¯¥å‘é€ä¸€ä¸ªUDPæ¶ˆæ¯å‘ŠçŸ¥è®¾å¤‡è‡ªå·±çš„IP
- æˆ–è€…åœ¨ `/trigger` æ¥å£ä¸­ï¼Œè®¾å¤‡è®°å½•è¯·æ±‚æ¥æºIP

---

## ğŸ”§ å»ºè®®çš„æ”¹è¿›å®ç°

### 1. æ·»åŠ UDPäº‹ä»¶è¶…æ—¶é‡è¯•æœºåˆ¶

```dart
Future<void> _handleVgaReady() async {
  // ç­‰å¾…UDPäº‹ä»¶ï¼Œå¦‚æœè¶…æ—¶åˆ™ä¸»åŠ¨è·å–
  final completer = Completer<void>();
  StreamSubscription? subscription;
  
  subscription = udpEvents.events.listen((event) {
    if (event == 'VGA_READY') {
      subscription?.cancel();
      if (!completer.isCompleted) completer.complete();
    }
  });
  
  // 5ç§’è¶…æ—¶
  Future.delayed(Duration(seconds: 5), () {
    if (!completer.isCompleted) {
      subscription?.cancel();
      completer.complete();
      debugPrint('âš ï¸ UDPäº‹ä»¶è¶…æ—¶ï¼Œä¸»åŠ¨è·å–VGAå›¾åƒ');
    }
  });
  
  await completer.future;
  // ç»§ç»­è·å–å›¾åƒ...
}
```

### 2. æ·»åŠ å›¾åƒè·å–é‡è¯•æœºåˆ¶

```dart
Future<Uint8List?> fetchVgaImageWithRetry(String deviceIp, {int maxRetries = 3}) async {
  for (int i = 0; i < maxRetries; i++) {
    try {
      final image = await fetchVgaImage(deviceIp);
      if (image != null) return image;
    } catch (e) {
      debugPrint('VGAè·å–å¤±è´¥ (å°è¯• ${i+1}/$maxRetries): $e');
    }
    if (i < maxRetries - 1) {
      await Future.delayed(Duration(milliseconds: 500));
    }
  }
  return null;
}
```

### 3. æ”¹è¿›è§¦å‘æŒ‡ä»¤çš„é”™è¯¯å¤„ç†

```dart
Future<void> _triggerCapture() async {
  // ... ç°æœ‰ä»£ç  ...
  
  // Trigger device capture with retry
  bool success = false;
  for (int i = 0; i < 3; i++) {
    success = await _httpClient.triggerCapture(discovery.currentDevice!.ip);
    if (success) break;
    await Future.delayed(Duration(milliseconds: 500));
  }
  
  if (!success && mounted) {
    setState(() {
      _errorMessage = 'æ— æ³•è§¦å‘è®¾å¤‡æ‹æ‘„ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
      _captureState = CaptureState.error;
    });
    return;
  }
}
```

---

## ğŸ“Š æµç¨‹å®Œæ•´æ€§è¯„åˆ†

| æ­¥éª¤ | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|
| æŒ‰é’®è§¦å‘ | âœ… å®Œæ•´ | æ— éœ€æ”¹è¿› |
| å‘é€è§¦å‘æŒ‡ä»¤ | âš ï¸ éœ€æ”¹è¿› | ç¼ºå°‘é‡è¯•æœºåˆ¶ |
| UDPäº‹ä»¶ç›‘å¬ | âœ… å®Œæ•´ | å·²æ­£ç¡®å®ç° |
| æ¥æ”¶UDPäº‹ä»¶ | âš ï¸ éœ€æ”¹è¿› | ç¼ºå°‘è¶…æ—¶é‡è¯• |
| è·å–VGAå›¾åƒ | âš ï¸ éœ€æ”¹è¿› | ç¼ºå°‘é‡è¯•æœºåˆ¶ |
| å¤„ç†ç§˜ä¹¦AI | âœ… å®Œæ•´ | æ— éœ€æ”¹è¿› |
| è·å–HDå›¾åƒ | âš ï¸ éœ€æ”¹è¿› | ç¼ºå°‘é‡è¯•æœºåˆ¶ |
| å¤„ç†ä¸“å®¶AI | âœ… å®Œæ•´ | æ— éœ€æ”¹è¿› |

**æ€»ä½“è¯„åˆ†**: 7/10
- æ ¸å¿ƒæµç¨‹å®Œæ•´ âœ…
- ç¼ºå°‘é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ âš ï¸

---

## ğŸ¯ ä¼˜å…ˆçº§å»ºè®®

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»å®ç°ï¼‰
1. **å›¾åƒè·å–é‡è¯•æœºåˆ¶** - é˜²æ­¢ç½‘ç»œæ³¢åŠ¨å¯¼è‡´å¤±è´¥
2. **UDPäº‹ä»¶è¶…æ—¶å¤„ç†** - é˜²æ­¢UDPä¸¢åŒ…å¯¼è‡´æµç¨‹ä¸­æ–­

### ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®å®ç°ï¼‰
1. è§¦å‘æŒ‡ä»¤é‡è¯•æœºåˆ¶
2. æ›´è¯¦ç»†çš„é”™è¯¯æç¤º

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰
1. æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—
2. ç½‘ç»œçŠ¶æ€æ£€æµ‹


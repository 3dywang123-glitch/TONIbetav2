# ESP32固件更新说明 v7.0

## 📋 新功能

### 1. UDP事件确认和重试机制 ✅
- **UDP事件重试**: 如果500ms内未收到App确认，自动重发UDP事件
- **最大重试次数**: 3次
- **确认消息处理**: 接收并处理 `ACK:VGA_READY` 和 `ACK:HD_READY`

### 2. App IP地址记录 ✅
- **自动记录**: 在 `/trigger` 接口中记录App的IP地址和端口
- **UDP发送**: 使用记录的IP地址发送UDP事件，确保能正确送达

### 3. 图像接收确认接口 ✅
- **接口**: `GET /ack_image?type=VGA` 或 `GET /ack_image?type=HD`
- **功能**: 接收App的图像接收确认
- **自动清理**: 收到确认后自动清除对应图像缓存，释放PSRAM

### 4. 连拍接口 ✅
- **接口**: `GET /burst?count=N`
- **功能**: 触发连拍序列，连续拍摄N张HD图像
- **事件通知**: 每张图像拍摄完成后发送 `EVENT:HD_READY`

---

## 🔧 关键改进

### 1. 缓存管理优化
- **自动清理**: 收到图像确认后立即清除缓存
- **PSRAM释放**: 确保ESP32保持最高工作效率
- **内存管理**: 避免内存碎片和溢出

### 2. 可靠性提升
- **UDP重试**: 防止UDP事件丢失
- **确认机制**: 确保App收到事件通知
- **IP记录**: 确保UDP能正确发送到App

### 3. 性能优化
- **快速确认**: UDP确认超时时间仅500ms
- **异步处理**: 确认处理不阻塞主流程
- **及时清理**: 图像传输完成后立即释放内存

---

## 📊 工作流程

### 正常拍摄流程

```
1. App发送 GET /trigger
   ↓
2. 设备记录App IP，开始拍摄序列
   ↓
3. T+0.6s: 拍摄VGA，发送 EVENT:VGA_READY
   ↓
4. 等待App确认（最多500ms）
   ↓
5. 如果未收到确认，重发事件（最多3次）
   ↓
6. App收到事件，发送 ACK:VGA_READY
   ↓
7. 设备收到确认，停止重试
   ↓
8. App获取图像，发送 GET /ack_image?type=VGA
   ↓
9. 设备收到确认，清除VGA缓存
   ↓
10. T+3.0s: 拍摄HD，发送 EVENT:HD_READY
   ↓
11. 重复确认流程
   ↓
12. App获取图像，发送 GET /ack_image?type=HD
   ↓
13. 设备收到确认，清除HD缓存
```

### 连拍流程

```
1. App发送 GET /burst?count=5
   ↓
2. 设备开始连拍序列
   ↓
3. 每500ms拍摄一张HD图像
   ↓
4. 每张图像拍摄完成后发送 EVENT:HD_READY
   ↓
5. App接收图像并发送确认
   ↓
6. 设备收到确认后清除缓存
   ↓
7. 重复直到所有图像拍摄完成
```

---

## 🔑 关键配置

### UDP确认超时
```cpp
#define ACK_TIMEOUT 500      // 500毫秒
```

### 最大重试次数
```cpp
#define MAX_UDP_RETRIES 3    // 最多重试3次
```

### 连拍间隔
```cpp
// 在 handleBurstSequence() 中
if (elapsed >= 500) {  // 每500ms一张
```

---

## 📝 代码变更

### 新增变量
- `appIP`, `appPort`: 记录App IP地址
- `vgaAckReceived`, `hdAckReceived`: UDP确认状态
- `vgaEventTime`, `hdEventTime`: UDP事件发送时间
- `vgaRetryCount`, `hdRetryCount`: 重试计数
- `burstCount`, `burstRemaining`, `isBursting`: 连拍状态

### 新增函数
- `sendVgaEventWithRetry()`: 发送VGA事件（带重试）
- `sendHdEventWithRetry()`: 发送HD事件（带重试）
- `checkUdpAckTimeout()`: 检查UDP确认超时
- `clearImageCache()`: 清除图像缓存
- `handleBurstSequence()`: 处理连拍序列

### 修改的函数
- `handleUdpDiscovery()`: 添加确认消息处理
- `/trigger` 接口: 记录App IP地址
- `/latest_vga`, `/latest_hd`: 保持不变

### 新增接口
- `GET /ack_image?type=VGA|HD`: 图像接收确认
- `GET /burst?count=N`: 连拍触发

---

## ⚠️ 注意事项

1. **内存管理**: 图像确认后立即清除，确保PSRAM可用
2. **UDP重试**: 如果网络不稳定，可能会多次重发事件
3. **App IP**: 如果App重启，需要重新触发 `/trigger` 来更新IP
4. **连拍间隔**: 当前设置为500ms，可根据需要调整

---

## 🎯 性能优化

### 内存释放
- ✅ 图像传输完成后立即清除缓存
- ✅ 避免内存碎片
- ✅ 保持PSRAM可用空间

### 网络优化
- ✅ UDP确认超时仅500ms
- ✅ 快速重试机制
- ✅ IP地址缓存，减少查找时间

### 工作流优化
- ✅ 确认处理不阻塞主流程
- ✅ 异步清理缓存
- ✅ 及时释放资源

---

## 📦 文件说明

**新文件**: `xiao_esp32s3_sence_v7_with_ack.ino`
- 完整的v7.0固件代码
- 包含所有确认和重试机制
- 包含连拍功能
- 包含缓存清理功能

**旧文件**: `xiao_esp32s3_sence.txt`
- 保留作为参考
- 不包含确认机制

---

## ✅ 测试建议

1. **UDP确认测试**
   - 验证设备能正确接收App的确认消息
   - 验证超时重试机制

2. **缓存清理测试**
   - 验证收到确认后缓存被清除
   - 验证PSRAM使用情况

3. **连拍测试**
   - 验证连拍序列正常工作
   - 验证每张图像都能正确发送事件

4. **IP记录测试**
   - 验证App IP被正确记录
   - 验证UDP事件能正确发送到App

